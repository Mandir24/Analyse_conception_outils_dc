{% extends "base.html" %}

{% block title %}Universités et Recherche - World-Univ-Rank{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1> <i class="bi bi-building me-2"></i> Analyse des Classements Universitaires </h1>
        <p class="lead">Classement mondial des universités basé sur l'année la plus récente.</p>
    </div>
</div>

<div class="container my-5">
    
    <section class="mb-5">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-award me-2"></i> Top 5 universités en enseignement</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTop5Teaching"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-lightbulb-fill me-2"></i> Top 5 Score Recherche</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTop5Research"></canvas>
                    </div>
                </div>
            </div>


            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-graph-down me-2"></i> Bottom 5 Score Enseignement</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartBottom5Teaching"></canvas>
                    </div>
                </div>
            </div>

            
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i> Bottom 5 Score Recherche</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartBottom5Research"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <hr class="my-5">

    <section class="mb-5">
        <h2 class="border-bottom pb-2 mb-4 text-secondary"><i class="bi bi-sliders me-2"></i> Filtres Personnalisés</h2>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                {# Changé la méthode du formulaire pour GET afin de préserver les filtres lors de la pagination #}
                <form method="GET" action="{{ url_for('universites') }}" class="row g-3 align-items-end">
                    {{ form.hidden_tag() }} 

                    <div class="col-md-3">
                        <label for="{{ form.pays.id }}" class="form-label"><i class="bi bi-pin-map me-1"></i> Pays</label>
                        {{ form.pays(class="form-select") }}
                    </div>

                    <div class="col-md-2">
                        <label for="{{ form.annee.id }}" class="form-label"><i class="bi bi-calendar-range me-1"></i> Année</label>
                        {{ form.annee(class="form-select") }}
                    </div>

                    <div class="col-md-3">
                        <label for="{{ form.score_enseig_min.id }}" class="form-label"><i class="bi bi-book-half me-1"></i> Score Enseignement Min</label>
                        {{ form.score_enseig_min(class="form-control", placeholder="Min (0-100)") }}
                        {% for error in form.score_enseig_min.errors %}
                            <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div class="col-md-3">
                        <label for="{{ form.score_rech_min.id }}" class="form-label"><i class="bi bi-flask-fill me-1"></i> Score Recherche Min</label>
                        {{ form.score_rech_min(class="form-control", placeholder="Min (0-100)") }}
                        {% for error in form.score_rech_min.errors %}
                            <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-funnel"></i> Filtrer</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <hr class="my-5">
    <section class="mb-5">
        
        {# MISE À JOUR DU TITRE AVEC LE COMPTE TOTAL #}
        {% set titre_liste_defaut = "Classement Mondial des Universités | {0} entrée(s), Année {1} ".format(total_count, annee_affichée | default('N/A')) %}
        {% set titre_liste_filtre = "Résultats Trouvés ({0} entrée(s) de classement, Année {1})".format(total_count, annee_affichée) %}

        <h2 class="border-bottom pb-2 mb-4 text-secondary">
            <i class="bi bi-list-ol me-2"></i> {{ titre_liste_filtre if is_search_request or pagination.page > 1 else titre_liste_defaut }}
        </h2>

        {% if universites_a_afficher %}
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-striped table-hover result-table">
                <thead style="background-color: var(--castleton-dark); color: white;">
                    <tr>
                        <th style="width: 5%;">Rang</th>
                        <th>Université</th>
                        <th style="width: 15%;">Pays</th>
                        <th style="width: 15%;">Région</th>
                        <th class="text-center" style="width: 10%;">Enseignement</th>
                        <th class="text-center" style="width: 10%;">Recherche</th>
                        <th class="text-center" style="width: 10%;">Score Global</th>
                        <th style="width: 10%;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {# Boucle sur la liste de la page actuelle #}
                    {% for univ in universites_a_afficher %}
                    <tr>
                        <td>
                            {% set rang = univ[1] %}
                            {% set badge_class = 'bg-dark' %}
                            
                            {# Application des classes de rang spécifiques #}
                            {% if rang == 1 %}
                                {% set badge_class = 'badge-rank-1' %}
                            {% elif rang == 2 %}
                                {% set badge_class = 'badge-rank-2' %}
                            {% elif rang == 3 %}
                                {% set badge_class = 'badge-rank-3' %}
                            {% endif %}
                            
                            <span class="badge {{ badge_class }}">{{ rang }}</span>
                        </td>
                        <td class="univ-name">{{ univ[2] }}</td>
                        <td>{{ univ[3] }}</td>
                        <td>{{ univ[4] }}</td>
                        <td class="text-center">
                            <span class="badge rounded-pill bg-info">{{ univ[5] | round(1) if univ[5] is not none else '-' }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge rounded-pill bg-success">{{ univ[6] | round(1) if univ[6] is not none else '-' }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge rounded-pill bg-primary">{{ univ[7] | round(1) if univ[7] is not none else '-' }}</span>
                        </td>
                        <td>
                            <a href="{{ url_for('fiche_universite', id=univ[0]) }}" class="btn btn-sm btn-outline-dark">
                                <i class="bi bi-eye"></i> Détails
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {# BLOC DE PAGINATION  #}
        <div class="d-flex justify-content-between align-items-center mt-4">
            <p class="text-muted small mb-0">
                Affichage des résultats {{ (pagination.page - 1) * pagination.per_page + 1 }} à {{ (pagination.page - 1) * pagination.per_page + pagination.items|length }} sur {{ pagination.total }}
            </p>

            {% if pagination.pages > 1 %}
                <nav aria-label="Navigation des résultats">
                    <ul class="pagination pagination-sm mb-0">
                        {# Bouton Précédent #}
                        <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                            <a class="page-link" href="{{ url_for('universites', 
                                page=pagination.prev_num(), 
                                pays=form.pays.data | default(''), 
                                annee=form.annee.data | default(''), 
                                score_enseig_min=form.score_enseig_min.data | default(''), 
                                score_rech_min=form.score_rech_min.data | default('')) 
                            }}" aria-label="Précédent">
                                <i class="bi bi-arrow-left"></i> Précédent
                            </a>
                        </li>

                        {# Liens vers les pages #}
                        {% for p in pagination.iter_pages() %}
                            {% if p %}
                                {% if p == pagination.page %}
                                    <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ p }}</a></li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('universites', 
                                            page=p, 
                                            pays=form.pays.data | default(''), 
                                            annee=form.annee.data | default(''), 
                                            score_enseig_min=form.score_enseig_min.data | default(''), 
                                            score_rech_min=form.score_rech_min.data | default('')) 
                                        }}">
                                            {{ p }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                            {% endif %}
                        {% endfor %}

                        {# Bouton Suivant #}
                        <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                            <a class="page-link" href="{{ url_for('universites', 
                                page=pagination.next_num(), 
                                pays=form.pays.data | default(''), 
                                annee=form.annee.data | default(''), 
                                score_enseig_min=form.score_enseig_min.data | default(''), 
                                score_rech_min=form.score_rech_min.data | default('')) 
                            }}" aria-label="Suivant">
                                Suivant <i class="bi bi-arrow-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            {% endif %}
        </div>
        {# fin pagination #}

        {% elif is_search_request %}
            <div class="alert alert-warning mt-4" role="alert">
                <i class="bi bi-x-octagon-fill me-2"></i> Aucune université trouvée correspondant aux critères spécifiés pour l'année {{ annee_affichée }}.
            </div>
        {% else %}
             <div class="alert alert-info mt-4" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i> Le classement pour l'année {{ annee_affichée | default('N/A') }} est vide ou non disponible.
            </div>
        {% endif %}
    </section>
    
    {# Remonter en Haut #}
    <button id="scrollToTopBtn" title="Remonter en haut">
        <i class="bi bi-arrow-up"></i>
    </button>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
                if (typeof createHorizontalBarChart === 'undefined' || typeof chartColors === 'undefined') {
            console.error("Erreur: Les fonctions Chart.js (chart-functions.js) ne sont pas définies. Vérifiez le lien.");
            return;
        }
        
        // Récupération sécurisée des données JSON passées par Flask
        const dataTop5Teaching = {{ data_top5_teaching | tojson | default('{}') | safe }};
        const dataBottom5Teaching = {{ data_bottom5_teaching | tojson | default('{}') | safe }};
        const dataTop5Research = {{ data_top5_research | tojson | default('{}') | safe }};
        const dataBottom5Research = {{ data_bottom5_research | tojson | default('{}') | safe }};
        
        // --- Initialisation des Graphiques ---
        
        // 1. Top 5 Enseignement (Couleur INFO)
        if (dataTop5Teaching.labels && dataTop5Teaching.labels.length > 0) {
            createHorizontalBarChart(
                'chartTop5Teaching', 
                dataTop5Teaching.labels, 
                dataTop5Teaching.data, 
                chartColors.info, 
                "Score Enseignement"
            );
        }

        // 2. Bottom 5 Enseignement (Couleur WARNING)
        if (dataBottom5Teaching.labels && dataBottom5Teaching.labels.length > 0) {
            createHorizontalBarChart(
                'chartBottom5Teaching', 
                dataBottom5Teaching.labels, 
                dataBottom5Teaching.data, 
                chartColors.warning, 
                "Score Enseignement"
            );
        }

        // 3. Top 5 Recherche (Couleur SUCCESS)
        if (dataTop5Research.labels && dataTop5Research.labels.length > 0) {
            createHorizontalBarChart(
                'chartTop5Research', 
                dataTop5Research.labels, 
                dataTop5Research.data, 
                chartColors.success, 
                "Score Recherche"
            );
        }

        // 4. Bottom 5 Recherche (Couleur DANGER)
        if (dataBottom5Research.labels && dataBottom5Research.labels.length > 0) {
            createHorizontalBarChart(
                'chartBottom5Research', 
                dataBottom5Research.labels, 
                dataBottom5Research.data, 
                chartColors.danger, 
                "Score Recherche"
            );
        }
    });
</script>
{% endblock %}